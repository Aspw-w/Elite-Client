package com.instrumentalist.elite.hacks.features.exploit.disablermode.features;

import com.instrumentalist.elite.events.features.*;
import com.instrumentalist.elite.hacks.features.exploit.disablermode.DisablerEvent;
import com.instrumentalist.elite.utils.ChatUtil;
import com.instrumentalist.elite.utils.IMinecraft;
import com.instrumentalist.elite.utils.packet.PacketUtil;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;

public class MinibloxDisabler implements DisablerEvent {

    @Override
    public String getName() {
        return "Miniblox";
    }

    public static long tick = 0;
    public static int cancelTick = 0;

    @Override
    public void onUpdate(UpdateEvent event) {
    }

    @Override
    public void onMotion(MotionEvent event) {
    }

    @Override
    public void onTick(TickEvent event) {
    }

    @Override
    public void onAttack(AttackEvent event) {
    }

    @Override
    public void onSendPacket(SendPacketEvent event) {
        if (IMinecraft.mc.player == null || IMinecraft.mc.player.age < 50) return;

        Packet<?> packet = event.packet;

        if (packet instanceof PlayerMoveC2SPacket && IMinecraft.mc.player.getY() > -64 && tick + 820 < System.currentTimeMillis()) {
            PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.PositionAndOnGround(IMinecraft.mc.player.getX(), -58.0, IMinecraft.mc.player.getZ(), true, IMinecraft.mc.player.horizontalCollision));
            PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.OnGroundOnly(false, IMinecraft.mc.player.horizontalCollision));
            PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.OnGroundOnly(true, IMinecraft.mc.player.horizontalCollision));
            cancelTick = 3;
            event.cancel();
            tick = System.currentTimeMillis();
        }
    }

    @Override
    public void onReceivedPacket(ReceivedPacketEvent event) {
        if (IMinecraft.mc.player == null || IMinecraft.mc.player.age < 50) return;

        Packet<?> packet = event.packet;

        if (packet instanceof PlayerPositionLookS2CPacket) {
            if (cancelTick > 1) {
                event.cancel();
                cancelTick--;
                PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.Full(((PlayerPositionLookS2CPacket) packet).change().position().x, ((PlayerPositionLookS2CPacket) packet).change().position().y, ((PlayerPositionLookS2CPacket) packet).change().position().z, ((PlayerPositionLookS2CPacket) packet).change().yaw(), ((PlayerPositionLookS2CPacket) packet).change().pitch(), true, IMinecraft.mc.player.horizontalCollision));
            } else {
                cancelTick--;
                event.cancel();
                PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.Full(((PlayerPositionLookS2CPacket) packet).change().position().x, ((PlayerPositionLookS2CPacket) packet).change().position().y, ((PlayerPositionLookS2CPacket) packet).change().position().z, ((PlayerPositionLookS2CPacket) packet).change().yaw(), ((PlayerPositionLookS2CPacket) packet).change().pitch(), true, IMinecraft.mc.player.horizontalCollision));
                for (int i = 0; i <= 16; i++) {
                    PacketUtil.sendPacketAsSilent(new PlayerMoveC2SPacket.PositionAndOnGround(IMinecraft.mc.player.getX(), -48.0, IMinecraft.mc.player.getZ(), false, IMinecraft.mc.player.horizontalCollision));
                }
                ChatUtil.printChat("final tick");
            }
        }
    }

    @Override
    public void onWorld(WorldEvent event) {
    }
}